---
title: 'anova analysis'
output:
  html_document:
    df_print: paged
  pdf_document: default
  html_notebook: default
---


```{r setup, include=FALSE}
library(rgl)
knitr::opts_chunk$set(echo = TRUE)
knitr::knit_hooks$set(webgl = hook_webgl)
```

```{css, echo=FALSE}
.extracode {
background-color: lightblue;
}
```
```{r}
setwd('C:/Users/Elena/Desktop/Elena/Polimi/MAGISTRALE/Nonparametric statistics/Progetto/github repository/ALZHEIMER_prognonpa/Elena')
dataset_xsectional <- read.csv("oasis_cross-sectional.csv", header = T)
dataset_longitudinal <- read.csv("oasis_longitudinal.csv", header = T)
```


We are interested in the importance of variables sex and age in the prediction of the state of the patient (if demented or not). So we can start analyzing these two variables wrt the grouping: sex and age can be thought as categorical and we use CDR as dependent variable.


Check for only the **FIRST** visit of each patient to have independence

```{r}
data11 <- dataset_longitudinal[which(dataset_longitudinal$Visit == 1),]
data11 <- data.frame(as.factor(data11$M.F), as.factor(data11$Age), data11$CDR)
colnames(data11) <- c('M.F','Age','CDR')
```

```{r}
anova11 <- aov(CDR~M.F+Age+M.F:Age, data=data11)
summary(anova11)
```

sex is really significant, Age is not significat, the interaction between them is significant



```{r}
plot(anova11)
```


the residuals seem to be not normal nor homogenously distributed in the graph (so not homoschedastic)


```{r}
shapiro.test(anova11$residuals)
```
```{r}
anova12 <- aov(CDR~M.F, data=data11)
summary(anova12)
shapiro.test(anova12$residuals)
plot(anova12)
```
```{r}
anova13 <-aov(CDR~Age, data=data11)
summary(anova13)
shapiro.test(anova13$residuals)
plot(anova13)
```
we don't have normality of residuals



since we cannot assume normality of residuals (pvalue very low) we should use a nonparametric test (ex kruskal wallis)


```{r}
kw11 <- kruskal.test(CDR~M.F, data=data11)
kw11
```
hence the sex is significant


```{r}
kw12 <- kruskal.test(CDR~Age, data=data11)
kw12
```
and the age is not


or use a permutation test:

```{r}
B = 1000
seed = 26111992
```

```{r}
# TEST ON THE FACTOR MF
T0_MF <- summary.aov(aov(CDR ~  M.F, data = data11))[[1]][1,4]
# residuals under H0
# km = mu
residuals.H0MF <- data11$CDR - mean(data11$CDR)

# Note that in this case, permuting the residuals under H0 
# and permuting the data is exactly the same:
n <- nrow(data11)
permutation <- sample(n)
CDR.perm.H0MF <- mean(data11$CDR) + residuals.H0MF[permutation]
CDR.perm  <- data11$CDR[permutation]

```

```{r}
T_MF <- numeric(B)
for(perm in 1:B){
  permutation <- sample(n)
  CDR.perm <- data11$CDR[permutation]
  T_MF[perm] <- summary.lm(aov(CDR.perm ~ M.F , data = data11))$f[1]
  
}
sum(T_MF >= T0_MF)/B

```



```{r}
# TEST ON THE FACTOR Age
T0_Age <- summary.aov(aov(CDR ~  Age, data = data11))[[1]][1,4]
# residuals under H0
# km = mu
residuals.H0Age <- data11$CDR - mean(data11$CDR)

# Note that in this case, permuting the residuals under H0 
# and permuting the data is exactly the same:
n <- nrow(data11)
permutation <- sample(n)
CDR.permAge  <- data11$CDR[permutation]

```

```{r}
T_Age <- numeric(B)
for(perm in 1:B){
  permutation <- sample(n)
  CDR.permAge <- data11$CDR[permutation]
  T_Age[perm] <- summary.lm(aov(CDR.permAge ~ Age , data = data11))$f[1]
  
}
sum(T_Age >= T0_Age)/B

```



Now we add the cross-sectional dataset (still with only the first visit to have independent data):

```{r}
data2 <- data.frame(as.factor(dataset_xsectional$M.F), as.factor(dataset_xsectional$Age), dataset_xsectional$CDR)
colnames(data2) <- c('M.F','Age','CDR')
datat <- rbind(data11, data2)
#datat <- na.omit(datat)
```

```{r}
anova2 <- aov(CDR~M.F+Age+M.F:Age, data=datat)
summary(anova2)
```




```{r}
plot(anova2)
```


the residuals seem to be not normal

```{r}
shapiro.test(anova2$residuals)
```
```{r}
shapiro.test(aov(CDR~M.F, data=datat)$residuals)
```
```{r}
shapiro.test(aov(CDR~Age, data=datat)$residuals)
```
we don't have normality of residuals




since we cannot assume normality of residuals (pvalue very low) we should use a nonparametric test (ex kruskal wallis)


```{r}
kw21 <- kruskal.test(CDR~M.F, data=datat)
kw21
```
hence the sex is significant


```{r}
kw22 <- kruskal.test(CDR~Age, data=datat)
kw22
```

but also age is significant (reject H0 of being not significant)!



```{r}
# TEST ON THE FACTOR MF
T0_MF <- summary.aov(aov(CDR ~  M.F, data = datat))[[1]][1,4]
# residuals under H0
# km = mu
residuals.H0MF <- datat$CDR - mean(datat$CDR)

# Note that in this case, permuting the residuals under H0 
# and permuting the data is exactly the same:
n <- nrow(datat)
permutation <- sample(n)
CDR.perm        <- datat$CDR[permutation]

```

```{r}
T_MF <- numeric(B)
for(perm in 1:B){
  permutation <- sample(n)
  CDR.perm <- datat$CDR[permutation]
  T_MF[perm] <- summary.lm(aov(CDR.perm ~ M.F , data = datat))$f[1]
  
}
sum(T_MF >= T0_MF)/B

```

```{r}
# TEST ON THE FACTOR Age
T0_Age <- summary.aov(aov(CDR ~  Age, data = datat))[[1]][1,4]
# residuals under H0
# km = mu
residuals.H0Age <- datat$CDR - mean(datat$CDR)

# Note that in this case, permuting the residuals under H0 
# and permuting the data is exactly the same:
n <- nrow(datat)
permutation <- sample(n)
CDR.permAge       <- datat$CDR[permutation]

```

```{r}
T_Age <- numeric(B)
for(perm in 1:B){
  permutation <- sample(n)
  CDR.permAge <- datat$CDR[permutation]
  T_Age[perm] <- summary.lm(aov(CDR.permAge ~ Age , data = datat))$f[1]
  
}
sum(T_Age >= T0_Age)/B

```

so both age and sex are signficant (we reject H0)



We could consider only the cross-sectional dataset (made by only first visits):


```{r}
anova22 <- aov(CDR~M.F+Age+M.F:Age, data=data2)
summary(anova22)
```

```{r}
plot(anova22)
```


```{r}
shapiro.test(anova22$residuals)
```
```{r}
shapiro.test(aov(CDR~M.F, data=data2)$residuals)
```
```{r}
shapiro.test(aov(CDR~Age, data=data2)$residuals)
```
we don't have normality of residuals



since we cannot assume normality of residuals (pvalue very low) we should use a nonparametric test (ex kruskal wallis)


```{r}
kw212 <- kruskal.test(CDR~M.F, data=data2)
kw212
```
hence the sex is not significant at 5%


```{r}
kw222 <- kruskal.test(CDR~Age, data=data2)
kw222
```

but also age is significant


or permutation test: 

```{r}
# TEST ON THE FACTOR MF
T0_MF <- summary.aov(aov(CDR ~  M.F, data = data2))[[1]][1,4]
# residuals under H0
# km = mu
residuals.H0MF <- data2$CDR - mean(data2$CDR)

# Note that in this case, permuting the residuals under H0 
# and permuting the data is exactly the same:
n <- nrow(data2)
permutation <- sample(n)
CDR.perm        <- data2$CDR[permutation]

```

```{r}
T_MF <- numeric(B)
for(perm in 1:B){
  permutation <- sample(n)
  CDR.perm <- data2$CDR[permutation]
  T_MF[perm] <- summary.lm(aov(CDR.perm ~ M.F , data = data2))$f[1]
  
}
sum(T_MF >= T0_MF)/B

```

```{r}
# TEST ON THE FACTOR Age
T0_Age <- summary.aov(aov(CDR ~  Age, data = data2))[[1]][1,4]
# residuals under H0
# km = mu
residuals.H0Age <- data2$CDR - mean(data2$CDR)

# Note that in this case, permuting the residuals under H0 
# and permuting the data is exactly the same:
n <- nrow(data2)
permutation <- sample(n)
CDR.permAge       <- data2$CDR[permutation]

```

```{r}
T_Age <- numeric(B)
for(perm in 1:B){
  permutation <- sample(n)
  CDR.permAge <- data2$CDR[permutation]
  T_Age[perm] <- summary.lm(aov(CDR.permAge ~ Age , data = data2))$f[1]
  
}
sum(T_Age >= T0_Age)/B

```
So in this case sex is not significant at 5% but age is.

However in our study we will consider the whole dataset of first visit, where both sex and age are significant.







We can also fastly check the other variables (with the complete dataset of first visits):

```{r}
library(dplyr)
data_l <- select(dataset_longitudinal[which(dataset_longitudinal$Visit == 1),], 6, 8:15)
data_x <- select(dataset_xsectional, 2, 4:11)
colnames(data_x)[colnames(data_x) == 'Educ'] <- 'EDUC'
data_total<-bind_rows(data_l,data_x)
```



```{r}
anova3 <- aov(CDR~EDUC, data=data_total)
summary(anova3)
shapiro.test(anova3$residuals)
kw3 <- kruskal.test(CDR~EDUC, data=data_total)
kw3
```
```{r}
anova4 <- aov(CDR~SES, data=data_total)
summary(anova4)
shapiro.test(anova4$residuals)
kw4 <- kruskal.test(CDR~SES, data=data_total)
kw4
```
```{r}
anova5 <- aov(CDR~MMSE, data=data_total)
summary(anova5)
shapiro.test(anova5$residuals)
kw5 <- kruskal.test(CDR~MMSE, data=data_total)
kw5
```
```{r}
anova6 <- aov(CDR~eTIV, data=data_total)
summary(anova6)
shapiro.test(anova6$residuals)
kw6 <- kruskal.test(CDR~eTIV, data=data_total)
kw6
```
```{r}
anova7 <- aov(CDR~nWBV, data=data_total)
summary(anova7)
shapiro.test(anova7$residuals)
kw7 <- kruskal.test(CDR~nWBV, data=data_total)
kw7
```
```{r}
anova8 <- aov(CDR~ASF, data=data_total)
summary(anova8)
shapiro.test(anova8$residuals)
kw8 <- kruskal.test(CDR~ASF, data=data_total)
kw8
```

all significant variables





